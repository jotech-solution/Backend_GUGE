{% extends 'base.html' %}
{% load static %}

{% block title %}Modifier la Question - Guge{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-block">
        <div class="row align-items-center">
            <div class="col-md-12">
                <div class="page-header-title">
                    <h5 class="m-b-10">Modifier la Question</h5>
                </div>
                <ul class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'home' %}">Accueil</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'question_list' %}">Questions</a></li>
                    <li class="breadcrumb-item">Modifier</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Formulaire de modification</h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    {% csrf_token %}
                    <div class="form-group mb-3">
                        <label class="form-label">Questionnaire</label>
                        <select name="template" class="form-select" required>
                            {% for template in templates %}
                            <option value="{{ template.id }}" {% if question.template_id == template.id %}selected{% endif %}>
                                {{ template.name }} ({{ template.get_type_display }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">Texte de la Question</label>
                        <textarea name="text" class="form-control" rows="3" required>{{ question.text }}</textarea>
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">Type de réponse</label>
                        <select name="kind" class="form-select" required>
                            {% for val, label in kind_choices %}
                            <option value="{{ val }}" {% if question.kind == val %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">Groupe (optionnel)</label>
                        <div class="input-group">
                            <select name="groupe" id="groupe-select" class="form-select">
                                <option value="">Aucun groupe</option>
                                {% for groupe in groupes %}
                                <option value="{{ groupe.id }}" {% if question.groupe_id == groupe.id %}selected{% endif %}>{{ groupe.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addGroupeModal" title="Ajouter un groupe">
                                <i class="ti ti-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-group mb-3" id="options-group" {% if question.kind != 'choice' %}style="display: none;"{% endif %}>
                        <label class="form-label">Options (séparées par des virgules)</label>
                        <input type="text" name="options" class="form-control" value="{{ question.options|join:', ' }}">
                        <small class="text-muted">Uniquement pour le type 'Choix'</small>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">Mettre à jour</button>
                        <a href="{% url 'question_list' %}" class="btn btn-light">Annuler</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour ajouter un groupe -->
<div class="modal fade" id="addGroupeModal" tabindex="-1" aria-labelledby="addGroupeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addGroupeModalLabel">Ajouter un Groupe</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addGroupeForm">
                    {% csrf_token %}
                    <div class="form-group mb-3">
                        <label class="form-label">Nom du Groupe</label>
                        <input type="text" name="name" id="groupe-name" class="form-control" required>
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">Description (optionnel)</label>
                        <textarea name="description" id="groupe-description" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">Ordre</label>
                        <input type="number" name="order" id="groupe-order" class="form-control" value="1" required>
                    </div>
                    <div id="addGroupeError" class="alert alert-danger" style="display: none;"></div>
                    <div id="addGroupeSuccess" class="alert alert-success" style="display: none;"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="addGroupeBtn">Ajouter</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const kindSelect = document.querySelector('select[name="kind"]');
        const optionsGroup = document.getElementById('options-group');

        kindSelect.addEventListener('change', function() {
            if (this.value === 'choice') {
                optionsGroup.style.display = 'block';
            } else {
                optionsGroup.style.display = 'none';
            }
        });

        // Gestion de l'ajout de groupe
        const addGroupeBtn = document.getElementById('addGroupeBtn');
        const addGroupeForm = document.getElementById('addGroupeForm');
        const addGroupeError = document.getElementById('addGroupeError');
        const addGroupeSuccess = document.getElementById('addGroupeSuccess');
        const groupeSelect = document.getElementById('groupe-select');
        const addGroupeModal = document.getElementById('addGroupeModal');

        addGroupeBtn.addEventListener('click', function() {
            addGroupeError.style.display = 'none';
            addGroupeSuccess.style.display = 'none';

            const name = document.getElementById('groupe-name').value;
            const description = document.getElementById('groupe-description').value;
            const order = document.getElementById('groupe-order').value;

            if (!name.trim()) {
                addGroupeError.textContent = 'Veuillez entrer un nom pour le groupe.';
                addGroupeError.style.display = 'block';
                return;
            }

            const csrfToken = document.querySelector('[name="csrfmiddlewaretoken"]').value;

            fetch('{% url "groupe_list" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({
                    name: name,
                    description: description,
                    order: parseInt(order),
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || 'Erreur lors de la création du groupe');
                    });
                }
                return response.json();
            })
            .then(data => {
                // Ajouter le nouveau groupe au select
                const option = document.createElement('option');
                option.value = data.id;
                option.textContent = data.name;
                option.selected = true;
                groupeSelect.appendChild(option);

                // Réinitialiser le formulaire et fermer le modal
                addGroupeForm.reset();
                document.getElementById('groupe-order').value = 1;
                addGroupeSuccess.textContent = 'Groupe créé avec succès!';
                addGroupeSuccess.style.display = 'block';

                setTimeout(() => {
                    const modal = bootstrap.Modal.getInstance(addGroupeModal);
                    modal.hide();
                }, 1500);
            })
            .catch(error => {
                addGroupeError.textContent = error.message;
                addGroupeError.style.display = 'block';
            });
        });
    });
</script>
{% endblock %}
